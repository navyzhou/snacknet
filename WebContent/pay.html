<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>源辰-零食网支付</title>
<meta name="keywords" content="小吃,美食,零食,源辰" />
<meta name="description" content="各种小吃美食，应有尽有" />
<link href="images/yc.png" rel="shortcut icon" type="image/x-icon" />
<link href="css/header.css" rel="stylesheet" type="text/css" />
<link href="css/pay.css" rel="stylesheet" type="text/css" />
<link href="css/footer.css" rel="stylesheet" type="text/css" />
</head>

<body>
<!-- 顶部区域 -->
<header id="header">
	<!-- 顶部标题区域 -->
	<div class="htitle">
    	<a href="#" target="_blank" class="location">衡阳</a>
        
        <div class="header-info">
            <div class="login-info" id="login_info">
            
            </div>
            
            <div class="person-info">
            	<span>|</span>
            	<a href="order.html" target="_blank">我的订单</a>
                <span>|</span>
                <a href="#" target="_blank">我的小吃</a>
                <span>|</span>
                <a href="#" target="_blank">客户服务</a>
                <span>|</span>
           		<a href="#" target="_blank">个人信息</a>
            </div>
        
        </div>
    </div>
    
    <!-- 顶部搜索区域 -->
    <div class="search">
    	<div class="search_left">
    		<a href="index.html" title="首页">
            	<img src="images/logo.png" width="260px" height="120px"/> 
            </a>
        </div>
        
        <div class="search_right">
        	<div class="search_top">
                <div class="search_div">
                    <input type="search" class="search-ipt" placeholder="请输入要搜索的内容" />
                    <input type="button" class="search-btn"/>  
                </div>
                <div class="buycart">
                	<i class="iconfont" id="iconfont">0</i>
                    <a href="cart.html" target="_blank">我的购物车</a>
                </div>
            </div>
            
            <div class="search_item" id="search_item">
            </div>
        </div>
    </div>
</header>

     
<!-- 收货地址 -->
<h3 class="common_title">确认收货地址</h3>

<div class="common_list_con clearfix">
    <input type="hidden" id="default_addr"/>
    <input type="hidden" id="current_addr"/>
    <dl id="addr_list">
        <dt>寄送到：</dt>
        <!-- <dd class="default_location">北京市 海淀区 东北旺西路8号中关村软件园 （李思 收） 159****0775 </dd>
        <dd class="current_location">北京市 海淀区 东北旺西路8号中关村软件园 （李思 收） 159****0775</dd> -->
    </dl>
    <a href="javascript:showAddrDiv()" class="edit_site">编辑收货地址</a>
</div>

<div id="addr_div">
    <img src="images/close.png" title="关闭" onclick="hiddenDiv()"/>
    <form id="myform">
        <ul>
            <li>
                <label for="addr_name">收货人：</label>
                <input id="addr_name" name="name" type="text" placeholder="请输入收货人姓名..." />
            </li>
            <li>
                <label for="addr_tel">联系方式：</label>
                <input id="addr_tel" name="tel" type="text" placeholder="请输入收货人联系方式..." />
            </li>
            <li>
                <label>收货地址：</label>
                <select id="province" name="province"></select>
                <select id="city" name="city">
                    <option value="0">--请选择城市--</option>
                </select>
                <select id="area" name="area">
                    <option value="0">--请选择地区--</option>
                </select>
            </li>
            <li>
                <label for="addr_addr">详细地址：</label>
                <input id="addr_addr" name="addr" style='width: 480px;' type="text" placeholder="请输入详细地址（街道、门牌等）" />
            </li>
            <li class="addr_btn">
                <a href="javascript:addAddr()" >添加收货地址</a>
            </li>
        </ul>
    </form>
</div>

<!-- 支付方式 -->	
<h3 class="common_title">支付方式</h3>	
<div class="common_list_con clearfix">
    <div class="pay_style_con clearfix">
        <input type="radio" name="pay_style">
        <label class="cash">货到付款</label>
        <input type="radio" name="pay_style">
        <label class="weixin">微信支付</label>
        <input type="radio" name="pay_style" checked> 
        <label class="zhifubao"></label>
        <input type="radio" name="pay_style">
        <label class="bank">银行卡支付</label>
    </div>
</div>

<!-- 商品列表 -->
<h3 class="common_title">商品列表</h3>
<div class="common_list_con clearfix" id="order_list">
    <ul class="goods_list_th clearfix">
        <li class="col01">商品名称</li>
        <li class="col02">商品单位</li>
        <li class="col03">商品价格</li>
        <li class="col04">数量</li>
        <li class="col05">小计</li>		
    </ul>
    <!-- <ul class="goods_list_td clearfix">
        <li class="col01">1</li>			
        <li class="col02"><img src="images/goods/good03.jpg"></li>
        <li class="col03">辣条</li>
        <li class="col04">500g</li>
        <li class="col05">16.80元</li>
        <li class="col06">1</li>
        <li class="col07">16.80元</li>	
    </ul> -->
</div>
 
<!-- 金额结算 -->	
<h3 class="common_title">总金额结算</h3>
<div class="common_list_con clearfix">
    <div class="settle_con">
        <div class="total_goods_count">共<em id="totalcount"></em>件商品，总金额<b id="total_price"></b> 元</div>
        <div class="transit">运费：<b>10元</b></div>
        <div class="total_pay">实付款：<b id="total_pay"></b> 元</div>
    </div>
</div>
<div class="order_submit clearfix">
    <a href="javascript:void(0);" id="order_btn" onclick="orderPay()">提交订单</a>
</div>	

<div class="popup_con">
    <div class="popup">
        <p>订单提交成功，请支付...</p>
    </div>
    <div class="mask"></div>
</div>    
        
<footer>
	<div class="foot_link">
        <a href="#">关于我们</a> <span> | </span>
        <a href="#">联系我们</a> <span> | </span>
        <a href="#">招聘广告</a> <span> | </span>
        <a href="#">友情链接</a>
    </div>
    <p>CopyRight &copy; 2019 <a class="copy" href="http://www.hyycinfo.com" target="_blank">衡阳市源辰信息科技有限公司</a> All Rights Reserverd</p>
    <p>电话：0734-8355998 湘ICP备16015987号-1</p>
</footer>

<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/checkLogin.js"></script>
<script src="js/addr.js"></script>
<script type="text/javascript">
var cnos = "";
var reg = /<[^><]*script[^><]*>/img;
$(function(){
	// 获取购买的商品信息
	cnos = location.hash.replace("#", "");
	if (cnos == "") {
		location.href="index.html";
		return;
	}
	
	$.post("cart", {op: "findByCnos", cnos: cnos}, function(result){
		if (result.code == 100) {
			location.href="index.html";
			return;
		} 
		
		var total = 0;
		var totalPrice = 0;
		var str = '';
		$.each(result.data, function(index, item) {
			str += '<ul class="goods_list_td clearfix"><li class="col01">'+(index + 1)+'</li>	';
			str += '<li class="col02"><img src="../../'+item.pics.split(";")[0]+'"></li>';
			str += '<li class="col03">'+item.gname.replace(reg, "")+'</li><li class="col04">'+item.weight.replace(reg, "")+'</li>';
			str += '<li class="col05">'+item.price+'元</li><li class="col06">'+item.num+'</li>';
			str += '<li class="col07">'+(item.num * item.price).toFixed(2)+'元</li></ul>';
			total += parseInt(item.num);
			totalPrice += item.num * item.price
		})
		$("#order_list").append($(str));
		$("#totalcount").text(total);
		$("#total_price").text(totalPrice.toFixed(2));
		$("#total_pay").text((totalPrice + 10).toFixed(2));
	}, "json");
	
	// 获取收货地址信息
	$.post("addr", {op: "findByMno"}, result => {
		if (result.code == 200) {
			var str = "";
			var temp = "";
			$.each(result.data, function(index, item) {
				if (item.flag == 1) { // 说明是默认地址
					$("#default_addr").val(item.ano);
					$("#current_addr").val(item.ano);
					str += '<dd class="default_location" data-id="' + item.ano + '">' + item.province + '&nbsp;' + item.city + '&nbsp;' + item.area + '&nbsp;';
					str += item.addr + '&nbsp;&nbsp;[' + item.name + '&nbsp;收]&nbsp;&nbsp;' + item.tel + '&nbsp;<span>默认收货地址</span>';
					str += '<a href="javascript:void(0)" onclick="setCurrentAddr(this, \''+item.ano+'\')">设为当前收货地址</a></dd>';
				} else {
					temp += '<dd>' + item.province + '&nbsp;' + item.city + '&nbsp;' + item.area + '&nbsp;';
					temp += item.addr + '&nbsp;&nbsp;[' + item.name + '&nbsp;收]&nbsp;&nbsp;' + item.tel + '&nbsp;';
					temp += '<a href="javascript:void(0)" onclick="setDefaultAddr(this,\''+item.ano+'\')">设为默认</a>';
					temp += '<a href="javascript:void(0)" onclick="setCurrentAddr(this, \''+item.ano+'\')">设为当前收货地址</a></dd>';
				}
			})
			str += temp;
			$("#addr_list").append($(str.replace(reg, "")));
		} else {
			location.href="login.html";
		}
	}, "json");
})

function addAddr() {
	var name = $.trim($("#addr_name").val());
	var tel =  $.trim($("#addr_tel").val());
	var province =  $.trim($("#province").val());
	var city =  $.trim($("#city").val());
	var area =  $.trim($("#area").val());
	var addr =  $.trim($("#addr_addr").val());
	

	if (reg.test(name) || reg.test(tel) || reg.test(addr)) {
		alert("您输入的信息不安全...");
		return;
	}
	
	if (name == "" ||  tel == "" || addr == "" || province == '--请选择省份--' || city == '--请选择城市--' || area == '--请选择地区--') {
		return;
	}
	
	var obj = $("#myform").serialize();
	var ano = new Date().getTime();
	var mno = $("#login_mno").val();
	obj += "&ano="+ano + "&op=add&mno=" + mno;
	
	$.post("addr", obj, function(data){
		data = parseInt($.trim(data));
		if (data == -2) {
			alert("您输入的信息不完整，请确认后重新提交...");
		} else if (data <= 0) {
			alert("地址信息添加失败，请稍后重试....");
		} else {
			var dd = $("#addr_list>dd[class='current_location']");
			var str = '<a href="javascript:void(0)" onclick="setCurrentAddr(this, \'' + $(dd).data("id") + '\')">设为当前收货地址</a>';
			$(dd).append($(str));
			$("#addr_list>dd").removeClass("current_location");
			
			var str = '<dd class="current_location" data-id="' + ano + '">' + province + '&nbsp;' + city + '&nbsp;' + area + '&nbsp;' + addr;
			str += '&nbsp;&nbsp;[' + name + '&nbsp;收]&nbsp;&nbsp;' + tel + '&nbsp';
			str += '<a href="javascript:void(0)" onclick="setDefaultAddr(this,\''+ano+'\')">设为默认</a></dd>';
			$("#myform")[0].reset();
			$("#addr_list").append($(str));
			$("#addr_div").css("display", "none");
			$("#current_addr").val(ano);
		}
	}, "text");
}

// 设为默认值
function setDefaultAddr(obj, ano) {
	var anos = ano;
	var dano = $.trim($("#default_addr").val());
	if (dano != "") {
		anos += "," + dano;
	}
	
	$.post("addr", {op:"update", anos: anos}, function(data) {
		data = parseInt($.trim(data));
		if (data > 0) {
			$("#default_addr").val(ano);
			var str = '<a href="javascript:void(0)" onclick="setDefaultAddr(this,\''+ dano + '\')">设为默认</a>';
			str += '<a href="javascript:void(0)" onclick="setCurrentAddr(this, \''+ dano + '\')">设为当前收货地址</a>';
			
			$(".default_location").append($(str)); // 添加默认事件
			$(".default_location").find("span").remove(); // 移除以前的默认地址标签
			$(".default_location").removeClass("default_location"); // 移除默认
			
			// 在当前地址后面加上 默认地址标签
			$(obj).parent().append("<span>默认收货地址</span>").addClass("default_location");
			// 当前这个设为默认的超链接移除
			$(obj).parent().find("a").remove();
			
		}
	},"text");
}

// 设置为当前收货地址
function setCurrentAddr(obj, ano) {
	$("#current_addr").val(ano);
	var dd = $("#addr_list>dd[class='current_location']");
	var str = '<a href="javascript:void(0)" onclick="setCurrentAddr(this, \'' + $(dd).data("id") + '\')">设为当前收货地址</a>';
	$(dd).append($(str));
	$("#addr_list>dd").removeClass("current_location");
	$(obj).parent().addClass("current_location");
	$(obj).remove();
}

function showAddrDiv() {
	$("#addr_div").css("display", "block");
}

function hiddenDiv() {
	$("#addr_div").css("display", "none");
}

function orderPay() {
	var ano = $("#current_addr").val() || $("#default_addr").val();
	if (ano == "") {
		alert("请选择收货地址...");
		return;
	}
	var price = $("#total_pay").text();
	$.post("order", {op:"add", cnos:cnos, ano:ano, price: price}, result => {
		if (result.code == 101) {
			alert("您输入的信息不完整...");
			return;
		}
		
		if (result.code == 200){
			$('.popup_con').fadeIn('fast', function() {
				setTimeout(function(){
					$('.popup_con').fadeOut('fast',function(){
						location.href = 'alipay?ono=' + result.data +"&price=" + price;
					});	
				}, 2000)
			});
		} else {
			alert("下单失败，请稍后重试...");
		}
	}, "json");
}
</script>
</body>
</html>
